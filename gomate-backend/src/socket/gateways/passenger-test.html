<!doctype html>
<html>
  <head>
    <title>Passenger Test - Create Ride Request</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      h1 {
        color: #0286ff;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      button {
        background: #0286ff;
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 16px;
        border-radius: 5px;
        cursor: pointer;
        margin: 10px 5px;
      }
      button:hover {
        background: #0266cc;
      }
      .log {
        background: #f9f9f9;
        border: 1px solid #ddd;
        padding: 15px;
        border-radius: 5px;
        margin-top: 20px;
        max-height: 400px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 13px;
      }
      .log div {
        margin: 5px 0;
        padding: 5px;
      }
      .log .success {
        color: green;
      }
      .log .error {
        color: red;
      }
      .log .info {
        color: blue;
      }
      input,
      select {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
      }
      label {
        font-weight: bold;
        display: block;
        margin-top: 15px;
      }
      code {
        background: #f0f0f0;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: monospace;
        font-size: 12px;
        color: #d63384;
      }
      .offer-card {
        animation: slideIn 0.3s ease-out;
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ðŸš— Passenger Test - Create Ride Request</h1>
      <p>
        Use this page to create test ride requests that will be sent to the
        driver app in real-time.
      </p>

      <div
        style="
          border: 1px solid #ddd;
          padding: 15px;
          border-radius: 5px;
          background: #f9f9f9;
        "
      >
        <h3>Connection Status</h3>
        <p id="status">Not connected</p>
        <button onclick="connectSocket()">Connect to Backend</button>
      </div>

      <div
        id="offersSection"
        style="
          display: none;
          margin-top: 20px;
          border: 2px solid #4caf50;
          padding: 15px;
          border-radius: 5px;
          background: #e8f5e9;
        "
      >
        <h3>ðŸ’° Counter Fare Offers Received</h3>
        <p id="offersCount" style="font-weight: bold">No offers received yet</p>
        <div id="offersList" style="margin-top: 15px"></div>
      </div>

      <div id="rideForm" style="display: none; margin-top: 20px">
        <h3>Create Test Ride</h3>

        <label>Passenger ID:</label>
        <input type="text" id="passengerId" value="688c69f20653ec0f43df6e2c" />

        <label>Passenger Name:</label>
        <input type="text" id="passengerName" value="Muhammad Ahmad Saeed" />

        <label>Ride Type:</label>
        <select id="rideType">
          <option value="car">Car</option>
          <option value="motorcycle">Motorcycle</option>
          <option value="auto">Auto Rickshaw</option>
        </select>

        <label>Ride Mode:</label>
        <select id="rideMode">
          <option value="solo">Solo</option>
          <option value="shared">Shared</option>
        </select>

        <label>Pickup Location (Coordinates [lng, lat]):</label>
        <input type="text" id="pickup" value="74.42618209999999,31.576079" />
        <small>Example: Cavalry Ground, Lahore</small>

        <label>Dropoff Location (Coordinates [lng, lat]):</label>
        <input type="text" id="dropoff" value="74.38324759999999,31.517179" />
        <small>Example: Liberty Market, Gulberg</small>

        <label>Fare (PKR):</label>
        <input type="number" id="fare" value="500" />

        <button onclick="createRide()">ðŸš€ Create Ride Request</button>
        <button onclick="createMultipleRides()">ðŸš€ Create 3 Test Rides</button>
      </div>

      <div class="log" id="log"></div>
    </div>

    <script>
      const socket = io('http://192.168.0.104:3000', {
        transports: ['polling', 'websocket'],
      });

      const passengerId = '688c69f20653ec0f43df6e2c';

      function log(message, type = 'info') {
        const logDiv = document.getElementById('log');
        const time = new Date().toLocaleTimeString();
        logDiv.innerHTML =
          `<div class="${type}">[${time}] ${message}</div>` + logDiv.innerHTML;
      }

      function connectSocket() {
        if (socket.connected) {
          log('Already connected!', 'info');
          return;
        }
        log('Connecting to backend...', 'info');
        socket.connect();
      }

      socket.on('connect', () => {
        log('âœ… Connected to backend! Socket ID: ' + socket.id, 'success');
        document.getElementById('status').innerHTML =
          'âœ… Connected (Socket: ' + socket.id + ')';
        document.getElementById('status').style.color = 'green';

        // Register as passenger
        const passengerId = document.getElementById('passengerId').value;
        socket.emit('registerPassenger', { passengerId });
        log('ðŸ“¡ Registering passenger: ' + passengerId, 'info');
        log(
          'ðŸ“¡ Ready to receive counter offers on socket: ' + socket.id,
          'info',
        );

        // Show ride form
        document.getElementById('rideForm').style.display = 'block';
      });

      socket.on('disconnect', () => {
        log('âŒ Disconnected from backend', 'error');
        document.getElementById('status').innerHTML = 'âŒ Disconnected';
        document.getElementById('status').style.color = 'red';
        document.getElementById('rideForm').style.display = 'none';
      });

      socket.on('connect_error', (error) => {
        log('ðŸ”´ Connection error: ' + error.message, 'error');
      });

      // Debug: Log all incoming events
      socket.onAny((eventName, ...args) => {
        console.log(`ðŸ“¨ Received event: ${eventName}`, args);
        if (eventName !== 'connect' && eventName !== 'disconnect') {
          log(`ðŸ“¨ Event received: ${eventName}`, 'info');
        }
      });

      // Listen for offer acceptance confirmation
      socket.on('offerAccepted', (data) => {
        log('ðŸŽ‰ Offer accepted successfully!', 'success');
        log(`  Ride ID: ${data.rideId}`, 'info');
        log(`  Driver ID: ${data.driverId}`, 'info');
        log(
          '  Ride is now confirmed! Driver will navigate to pickup.',
          'success',
        );
      });

      // Listen for individual counter offers (real-time)
      socket.on('receiveCounterOffer', (offer) => {
        log(
          `ðŸ’° Received counter offer from Driver ${offer.driver.id.substring(0, 8)}... - PKR ${offer.counterFare}`,
          'success',
        );

        // Show offers section
        document.getElementById('offersSection').style.display = 'block';

        // Add the new offer to the list
        const offersList = document.getElementById('offersList');

        const offerCard = document.createElement('div');
        offerCard.className = 'offer-card';
        offerCard.style.cssText =
          'background: white; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #0286FF; box-shadow: 0 2px 5px rgba(0,0,0,0.1);';
        offerCard.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong style="color: #0286FF;">Counter Offer</strong>
              <p style="margin: 5px 0; font-size: 13px; color: #666;">
                Driver: <strong>${offer.driver.firstname} ${offer.driver.lastname}</strong>
              </p>
              <p style="margin: 5px 0; font-size: 13px; color: #666;">
                Driver ID: <code>${offer.driver.id}</code>
              </p>
              <p style="margin: 5px 0; font-size: 13px; color: #666;">
                Phone: ${offer.driver.phoneNumber}
              </p>
              <p style="margin: 5px 0; font-size: 13px; color: #666;">
                Vehicle: ${offer.driver.vehicle.color} ${offer.driver.vehicle.company} ${offer.driver.vehicle.model}
              </p>
              <p style="margin: 5px 0; font-size: 13px; color: #666;">
                Plate: <code>${offer.driver.vehicle.plate}</code>
              </p>
              <p style="margin: 5px 0; font-size: 13px; color: #666;">
                Ride ID: <code>${offer.rideId}</code>
              </p>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">
                PKR ${offer.counterFare}
              </div>
              <button 
                onclick="acceptOffer('${offer.driver.id}', '${offer.rideId}', ${offer.counterFare})"
                style="margin-top: 10px; background: #4CAF50; padding: 8px 15px; font-size: 14px;">
                âœ… Accept Offer
              </button>
            </div>
          </div>
        `;
        offersList.appendChild(offerCard);

        // Update counter
        const currentCount = offersList.children.length;
        document.getElementById('offersCount').innerHTML =
          `âœ… ${currentCount} Offer(s) Received`;
      });

      // Keep the old driverOffers listener for backward compatibility (if needed)
      socket.on('driverOffers', (offers) => {
        log('ðŸ’° Received ' + offers.length + ' driver offer(s)!', 'success');

        // Show offers section
        document.getElementById('offersSection').style.display = 'block';
        document.getElementById('offersCount').innerHTML =
          `âœ… ${offers.length} Offer(s) Received`;

        // Clear previous offers
        const offersList = document.getElementById('offersList');
        offersList.innerHTML = '';

        // Display each offer
        offers.forEach((offer, index) => {
          log(
            `  ðŸ“‹ Offer ${index + 1}: Driver ${offer.driverId.substring(0, 8)}... - PKR ${offer.counterFare}`,
            'info',
          );

          const offerCard = document.createElement('div');
          offerCard.className = 'offer-card';
          offerCard.style.cssText =
            'background: white; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #0286FF; box-shadow: 0 2px 5px rgba(0,0,0,0.1);';
          offerCard.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong style="color: #0286FF;">Offer ${index + 1}</strong>
                <p style="margin: 5px 0; font-size: 13px; color: #666;">
                  Driver ID: <code>${offer.driverId}</code>
                </p>
                <p style="margin: 5px 0; font-size: 13px; color: #666;">
                  Ride ID: <code>${offer.rideId}</code>
                </p>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">
                  PKR ${offer.counterFare}
                </div>
                <button 
                  onclick="acceptOffer('${offer.driverId}', '${offer.rideId}', ${offer.counterFare})"
                  style="margin-top: 10px; background: #4CAF50; padding: 8px 15px; font-size: 14px;">
                  âœ… Accept Offer
                </button>
              </div>
            </div>
          `;
          offersList.appendChild(offerCard);
        });
      });

      function acceptOffer(driverId, rideId, fare) {
        log(
          `ðŸ“¤ Accepting offer from driver ${driverId.substring(0, 8)}... for PKR ${fare}`,
          'info',
        );

        socket.emit('acceptDriverOffer', {
          driverId: driverId,
          passengerId: document.getElementById('passengerId').value,
          rideId: rideId,
        });

        log('âœ… Offer accepted! Waiting for confirmation...', 'success');
      }

      function parseCoordinates(str) {
        const [lng, lat] = str.split(',').map((s) => parseFloat(s.trim()));
        return [lng, lat];
      }

      function createRide() {
        if (!socket.connected) {
          log('âš ï¸ Not connected! Click "Connect to Backend" first.', 'error');
          return;
        }

        const pickupCoords = parseCoordinates(
          document.getElementById('pickup').value,
        );
        const dropoffCoords = parseCoordinates(
          document.getElementById('dropoff').value,
        );

        const rideData = {
          passengerId: document.getElementById('passengerId').value,
          dto: {
            rideType: document.getElementById('rideType').value,
            rideMode: document.getElementById('rideMode').value,
            pickupLocation: {
              type: 'Point',
              coordinates: pickupCoords,
            },
            dropoffLocation: {
              type: 'Point',
              coordinates: dropoffCoords,
            },
            fare: parseInt(document.getElementById('fare').value),
          },
        };

        log('ðŸ“¤ Sending ride request...', 'info');
        log(
          'Ride Type: ' +
            rideData.dto.rideType +
            ', Mode: ' +
            rideData.dto.rideMode,
          'info',
        );
        log('Pickup: [' + pickupCoords.join(', ') + ']', 'info');
        log('Dropoff: [' + dropoffCoords.join(', ') + ']', 'info');
        log('Fare: PKR ' + rideData.dto.fare, 'info');

        socket.emit('createRideRequest', rideData);

        log(
          'âœ… Ride request sent! Nearby drivers should receive it now.',
          'success',
        );
      }

      function createMultipleRides() {
        if (!socket.connected) {
          log('âš ï¸ Not connected! Click "Connect to Backend" first.', 'error');
          return;
        }

        const testRides = [
          {
            pickup: [74.42618, 31.576079], // Cavalry Ground (100m from driver)
            dropoff: [74.38325, 31.517179], // Liberty Market
            fare: 500,
            type: 'car',
          },
          {
            pickup: [74.43012, 31.578123], // Near Cavalry Ground (300m from driver)
            dropoff: [74.40123, 31.560456], // Johar Town
            fare: 350,
            type: 'car',
          },
          {
            pickup: [74.42512, 31.573456], // Near driver location (500m from driver)
            dropoff: [74.38325, 31.517179], // Liberty Market
            fare: 250,
            type: 'car',
          },
        ];

        testRides.forEach((ride, index) => {
          setTimeout(() => {
            const rideData = {
              passengerId: document.getElementById('passengerId').value,
              dto: {
                rideType: ride.type,
                rideMode: 'solo',
                pickupLocation: {
                  type: 'Point',
                  coordinates: ride.pickup,
                },
                dropoffLocation: {
                  type: 'Point',
                  coordinates: ride.dropoff,
                },
                fare: ride.fare,
              },
            };

            socket.emit('createRideRequest', rideData);
            log(
              `âœ… Test ride ${index + 1}/3 sent (Fare: PKR ${ride.fare})`,
              'success',
            );
          }, index * 1000); // 1 second delay between rides
        });

        log('ðŸ“¤ Sending 3 test rides (1 second apart)...', 'info');
      }
    </script>
  </body>
</html>
